<html>
    <head>
        <link href="./sheet-styles.css" rel="stylesheet"/>
    </head>

    <body>
            <div class="sheet-znz-character-sheet">

        
        <div class="sheet-znz-area-unflexed">
            <label>Inventory</label>
            <div class="sheet-znz-section-inventory">
                <div class="sheet-znz-inventory-info sheet-znz-spaced-between">
                    <div class="sheet-znz-inventory-field-bag-select">
                        <div>
                            Bag Type:
                        </div>
                        <select name="attr_bagtype">
                            <option value="none" default>No Bag</option>
                            <option value="tiny">Satchel</option>
                            <option value="small">Daypack</option>
                            <option value="medium">Medium Backpack</option>
                            <option value="large">Large Rucksack</option>
                        </select>
                    </div>
                    <div class="sheet-znz-inventory-current-weight">
                        <div class="sheet-znz-inventory-label-current-weight">
                            Current Weight: 
                        </div>
                        <div class="sheet-znz-inventory-field-current-weight">
                            <input type="hidden" class="sheet-znz-hidden-weight-check" name="attr_weight_check" value="0"/>
                            <input type="number" class="sheet-znz-weight-check" name="attr_inventory_weight" readonly/>
                        </div>
                    </div>
                    <div class="sheet-znz-inventory-max-weight">
                        <div class="sheet-znz-inventory-field-bag-weight-label">
                            Max Weight:
                        </div>
                        <div class="sheet-znz-inventory-field-bag-weight-max">
                            <input type="number" name="attr_inventory_max_weight" readonly/>
                        </div>
                    </div>
                </div>

                <div class="sheet-znz-block-wrapper">
                    <div class="sheet-znz-block-item sheet-znz-unified-inventory">
                        <div class="sheet-znz-header sheet-znz-row">
                            <label>Items</label>
                            <div class="sheet-znz-inner-row sheet-znz-field sheet-znz-50 sheet-znz-right">

                                <div class="sheet-znz-inventory-controls">
                                    <button type="action" name="act_showall">Show All Details</button>
                                    <button type="action" name="act_hideall">Hide All Details</button>
                                </div>
                            </div>
                        </div>
                        <fieldset class="repeating_backpack">
                           <!--- Item Card Templater

    Template Variables
    inventory

-->


<div class="sheet-znz-item">
    
    <!-- Item Type and Name -->
    <div class="sheet-znz-row sheet-znz-no-margin">
        <div class="sheet-znz-field sheet-znz-15">
            <label>Item Type</label>
            <select name="attr_inventory_item_type" value="1">
                <option value="1" default>Misc</option>
                <option value="2">Melee Weapon</option>
                <option value="3">Ranged Weapon</option>
                <option value="4">Equipment</option>
            </select>
        </div>
        <div class="sheet-znz-field sheet-znz-75">
            <label>Name</label>
            <input type="text" name="attr_inventory_item_name"/>
        </div>
        <div class="sheet-znz-field sheet-znz-15">
            <label>Weight</label>
            <input type="number" name="attr_inventory_item_weight" min="0"/>
        </div>
    </div>
    
    <div class="sheet-znz-expand-button sheet-znz-expandable-section">
        <!--- This attribute is shared with an hidden input. The hidden one triggers the expand since expandables need to be siblings-->
        <input class="sheet-znz-expand-toggle" type="checkbox" name="attr_inventory_expand_item" checked>
        <label class="sheet-znz-expand-text" for="attr_@attributePrefix_expand_item"><span>Show Item Details</span></label>
        <label class="sheet-znz-collapse-text" for="attr_@attributePrefix_expand_item"><span>Hide Item Details</span></label>
    </div>
    
    <!--- First Expand - Whole Item Detail --->
    <input class="sheet-znz-hidden sheet-znz-expand" type="checkbox" name="attr_inventory_expand_item" checked>
    <div class="sheet-znz-expandable">
        <!-- Hidden Inputs for setting item type -->
        <input class="sheet-znz-hidden sheet-znz-item-type-1" type="checkbox" name="attr_inventory_item_type" value="1" checked/>
        <input class="sheet-znz-hidden sheet-znz-item-type-2" type="checkbox" name="attr_inventory_item_type" value="2"/>
        <input class="sheet-znz-hidden sheet-znz-item-type-3" type="checkbox" name="attr_inventory_item_type" value="3"/>
        <input class="sheet-znz-hidden sheet-znz-item-type-4" type="checkbox" name="attr_inventory_item_type" value="4"/>
        <input type="hidden" name="attr_inventory_item_type" value="1"/> <!--- This needs to be here to set the default value of the selected type if you're putting an expandable around the hidden checkboxes. Why? No Idea. -->
        
        <!--- Misc Fields-->
        <div class="sheet-znz-inventory-type-fields sheet-znz-inventory-item-misc-fields">
            <div class="sheet-znz-row sheet-znz-spaced">
                <div class="sheet-znz-field sheet-znz-25">
                    <label>Quantity</label>
                    <input type="number" min="0" name="attr_inventory_item_quantity"/>
                </div>
                <div class="sheet-znz-field sheet-znz-75">
                    <label>Effect</label>
                    <input type="text" name="attr_inventory_item_effect"/>
                </div>
            </div>
        </div>
        <!--- End Misc Fields --->
    
        <!--- Melee Fields-->
        <div class="sheet-znz-inventory-type-fields sheet-znz-inventory-item-melee-fields">
            <div class="sheet-znz-row sheet-znz-spaced">
                <div class="sheet-znz-field sheet-znz-25">
                    <label>Type Bonus</label>
                    <div class="sheet-znz-inner-row">
                        <select name="attr_@attributePrefix_melee_type">
                            <option value="blunt" default>Blunt</option>
                            <option value="sharp">Sharp</option>
                            <option value="heavy">Heavy</option>
                        </select>
                        <input type="number" name="attr_@attributePrefix_melee_bonus"/>
                    </div>
                </div>
                <div class="sheet-znz-field sheet-znz-15">
                    <label>Durability</label>
                    <div class="sheet-znz-inner-row">
                        <div>
                            <input type="number" min="0" name="attr_inventory_melee_durability"/>
                        </div>
                        <div class="sheet-divider">/</div>  
                        <div>
                            <input type="number" min="0" name="attr_inventory_melee_durability_max"/>
                            <div class="sheet-znz-description-text">
                                MAX
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sheet-znz-row">
                <div class="sheet-znz-field sheet-znz-full">
                    <label>Weapon Effect</label>
                    <input type="text" name="attr_inventory_item_effect"/>
                </div>
            </div>
            <div class="sheet-znz-row sheet-znz-centered">
                <div class="sheet-znz-field sheet-znz-33">
                    <button type="action" name="act_equipmelee">Equip Melee Weapon</button>
                </div>
            </div>
            
            <!--- Melee Expanding section-->
            <div class="sheet-znz-expand-button sheet-znz-expandable-section">
                <input class="sheet-znz-expand-toggle" type="checkbox" name="attr_inventory_expand_melee_details" />
                <label class="sheet-znz-expand-text" for="attr_@attributePrefix_expand_melee_details"><span>Show Extra Info</span></label>
                <label class="sheet-znz-collapse-text" for="attr_@attributePrefix_expand_melee_details"><span>Hide Extra Info</span></label>
            </div>
            <input class="sheet-znz-hidden sheet-znz-expand" type="checkbox" name="attr_inventory_expand_melee_details" />
            <div class="sheet-znz-expandable">
                <div class="sheet-znz-row sheet-znz-spaced">
                    <div class="sheet-znz-field">
                        <label>Attack Range</label>
                        <input type="number" min="0" name="attr_inventory_attack_range" value="1"/>
                    </div>
                    <div class="sheet-znz-field sheet-znz-right">
                        <label>Damage Bonus</label>
                        <input type="number" min="0" name="attr_inventory_damage_bonus" value="0"/>
                    </div>
                </div>
                <div class="sheet-znz-row sheet-znz-spaced">
                    <div class="sheet-znz-field">
                        <label>Bonus Damage Per Additional Energy</label>
                        <input type="number" name="attr_inventory_weapon_resource_bonus" value="1"/>
                    </div>
                    <div class="sheet-znz-field sheet-znz-right">
                        <label>Energy Consumption Per Attack</label>
                        <input type="number" name="attr_inventory_energy_consumption" value="1"/>
                    </div>
                </div>
            </div>
        </div>
        <!--- End Melee Fields --->
        
        <!-- Ranged Fields-->
        <div class="sheet-znz-inventory-type-fields sheet-znz-inventory-item-ranged-fields">
            <div class="sheet-znz-row sheet-znz-spaced">
                <div class="sheet-znz-field">
                    <label>Reloads</label>
                    <input type="number" min="0" name="attr_inventory_ranged_reloads"/>
                </div>
                <div class="sheet-znz-field">
                    <label>Ammo</label>
                    <div class="sheet-znz-inner-row">
                        <input type="number" min="0" name="attr_inventory_ranged_ammo"/>
                        <div class="sheet-divider">/</div>
                        <div>
                            <input type="number" min="0" name="attr_inventory_ranged_ammo_max"/>
                            <div class="sheet-znz-description-text">
                                MAX
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sheet-znz-row">
                <div class="sheet-znz-field sheet-znz-full">
                    <label>Weapon Effect</label>
                    <input type="text" name="attr_inventory_item_effect"/>
                </div>
            </div>
            <div class="sheet-znz-row sheet-znz-centered">
                <div class="sheet-znz-field">
                    <button type="action" name="act_equipranged">Equip Ranged Weapon</button>
                </div>
            </div>
            <div class="sheet-znz-expand-button sheet-znz-expandable-section">
                <input class="sheet-znz-expand-toggle" type="checkbox" name="attr_inventory_expand_ranged_details" />
                <label class="sheet-znz-expand-text" for="attr_@attributePrefix_expand_ranged_details"><span>Show Extra Info</span></label>
                <label class="sheet-znz-collapse-text" for="attr_@attributePrefix_expand_ranged_details"><span>Hide Extra Info</span></label>
            </div>
            <input class="sheet-znz-hidden sheet-znz-expand" type="checkbox" name="attr_inventory_expand_ranged_details" />
            <div class="sheet-znz-expandable">
                <div class="sheet-znz-row sheet-znz-spaced">
                    <div class="sheet-znz-field">
                        <label>Attack Range</label>
                        <input type="number" min="0" name="attr_inventory_attack_range"/>
                    </div>
                    <div class="sheet-znz-field sheet-znz-right">
                        <label>Damage Bonus</label>
                        <input type="number" min="0" name="attr_inventory_damage_bonus" value="0"/>
                    </div>
                </div>
                <div class="sheet-znz-row sheet-znz-spaced">
                    <div class="sheet-znz-field">
                        <label>Bonus Damage Per Additional Ammo</label>
                        <input type="number" min="1" name="attr_inventory_weapon_resource_bonus" value="1"/>
                    </div>
                </div>
            </div>
            
        </div>
        <!--- End Ranged Fields --->
        
        <!-- Equipment Fields-->
        <div class="sheet-znz-inventory-type-fields sheet-znz-inventory-item-equipment-fields">
            <div class="sheet-znz-row sheet-znz-spaced">
                <div class="sheet-znz-field">
                    <label>Damage Reduction</label>
                    <input type="number" name="attr_inventory_equipment_damage_reduction" value="0"/>
                </div>
                <div class="sheet-znz-field sheet-znz-right">
                    <label>Attribute Modifier</label>
                    <div class="sheet-znz-inner-row">
                        <select name="attr_equipment_attr_mod_type">
                            <option value="" selected>Select Attribute</option>
                            <option value="intelligence">Intelligence</option>
                            <option value="strength">Strength</option>
                            <option value="dexterity">Dexterity</option>
                            <option value="empathy">Empathy</option>
                            <option value="awareness">Awareness</option>
                            <option value="tenacity">Tenacity</option>
                            <option value="health">Health</option>
                        </select>
                        <input type="number" name="attr_equip_attr_bonus"/>
                    </div>
                </div>
            </div>
            <div class="sheet-znz-row">
                <div class="sheet-znz-field sheet-znz-25">
                    <label>Durability</label>
                    <div class="sheet-znz-inner-row">
                        <div>
                            <input type="number" min="0" name="attr_inventory_equipment_durability"/>
                        </div>
                        <div class="sheet-divider">/</div>  
                        <div>
                            <input type="number" min="0" name="attr_inventory_equipment_durability_max"/>
                            <div class="sheet-znz-description-text">
                                MAX
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sheet-znz-field sheet-znz-right">
                    <label>Proficiency Modifier</label>
                    <div class="sheet-znz-inner-row">
                        <select name="attr_equipment_prof_mod_type">
                            <option value="" selected>Select Proficiency</option>
                                <option value="pistols">Shooting Pistols</option>
                                <option value="shotguns">Shooting Shotguns</option>
                                <option value="rifles">Shooting Rifles</option>
                                <option value="unarmed">Unarmed Combat</option>
                                <option value="sharpmelee">Sharp Melee Weapons</option>
                                <option value="bluntmelee">Blunt Melee Weapons</option>
                                <option value="throwing">Throwing Weapons</option>
                                <option value="archery">Archery</option>
                                <option value="stealth">Stealth</option>
                                <option value="pickpocket">Pickpocketing</option>
                                <option value="repair">Basic Repair</option>
                                <option value="crafting">Basic Crafting</option>
                                <option value="driving">Driving</option>
                                <option value="cooking">Cooking</option>
                                <option value="firstaid">First Aid</option>
                                <option value="survival">Survival</option>
                                <option value="performance">Performance</option>
                                <option value="intimidation">Intimidation</option>
                                <option value="persuasion">Persuasion</option>
                                <option value="negotiation">Negotiation</option>
                                <option value="investigation">Investigation</option>
                                <option value="climbing">Climbing</option>
                                <option value="swimming">Swimming</option>
                                <option value="swimming">Athletics</option>
                        </select>
                        <input type="number" name="attr_equip_prof_bonus"/>
                    </div>
                </div>
            </div>
            <div class="sheet-znz-row">
                <div class="sheet-znz-field sheet-znz-full">
                    <label>Equipment Effect</label>
                    <input type="text" name="attr_inventory_item_effect"/>
                </div>
            </div>
            <div class="sheet-znz-row sheet-znz-centered">
                <div class="sheet-znz-field">
                    <button type="action" name="act_wearequipment">Wear Equipment</button>
                </div>
            </div>
            
        </div>
        <!--- End Equipment Fields-->

        <!-- Note -->
        <div class="sheet-znz-note">
            <label>Notes</label> 
            <textarea class="sheet-znz-reduced-height" name="attr_inventory_item_note" ></textarea>
        </div>
    </div>
    
</div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>

        <!--- Name and Stats --->
        <div class="sheet-znz-area">
            <div class="sheet-znz-section sheet-znz-section-name">
                <div class="sheet-znz-block sheet-znz-block-name">
                    <h2>Name</h2>
                    <input type="text" name="attr_name"></input>
                </div>
                <div class="sheet-znz-block sheet-znz-block-status">
                    <h2>Status</h2>
                    <input type="text" name="attr_status"></input>
                </div>
            </div>

            <div class="sheet-znz-section sheet-znz-section-status">
                <div class="sheet-znz-block sheet-znz-block-stat">
                    <h2>
                        Health
                    </h2>
                    <div class="sheet-znz-stat-container">
                        <div class="sheet-znz-input-field">
                            <input type="number" name="attr_hp" value="15"/>
                        </div>
                        <div class="sheet-znz-label-text">
                            <input type="hidden" name="attr_hp_max" value="15"/>
                            Max: <span class="sheet-znz-stat-max-text" readonly name="attr_hp_max"></span>
                        </div>
                    </div>
                </div>
                <div class="sheet-znz-block sheet-znz-block-stat">
                    <h2>
                        Sanity
                    </h2>
                    <div class="sheet-znz-stat-container">
                        <div class="sheet-znz-input-field">
                            <input type="number" name="attr_sanity" value="15" />
                        </div>
                        <div class="sheet-znz-label-text">
                            <input type="hidden" name="attr_sanity_max" value="15"/>
                            Max: <span class="sheet-znz-stat-max-text" readonly name="attr_sanity_max"></span>
                        </div>
                    </div>
                </div>
                <div class="sheet-znz-block sheet-znz-block-stat">
                    <h2>
                        Energy
                    </h2>
                    <div class="sheet-znz-stat-container">
                        <div class="sheet-znz-input-field">
                            <input type="number" name="attr_energy" value="15" />
                        </div>
                        <div class="sheet-znz-label-text">
                            <input type="hidden" name="attr_energy_max" value="30"/>
                            Max: <span class="sheet-znz-stat-max-text" readonly name="attr_energy_max"></span>
                        </div>
                    </div>
                </div>
                <div class="sheet-znz-block sheet-znz-block-stat">
                    <h2>Exp</h2>
                    <div class="sheet-znz-stat-container">
                        <input type="number" name="attr_exp" value="0" />
                    </div>
                    <div class="sheet-znz-label-text">
                        Learn Costs:
                        <div class="sheet-znz-description-text">10: +1 to any attribute or skill</div>
                        <div class="sheet-znz-description-text">30: Learn new ability.</div>
                    </div>
                </div>
            </div>
        </div>

        <!--- Attributes and Equipment --->
        <div class="sheet-znz-area">

            <div class="sheet-znz-section sheet-znz-section-attributes">
                <div class="sheet-znz-spaced-between">
                    Total Attribute Points <input type="number" name="attr_total_attr_points" class="sheet-znz-field-total-stat-points" readonly value="21"/>
                </div>
                <table class="sheet-znz-block-attrib-table">
                    <tr>
                        <th>
                            Attribute
                        </th>
                        <th>
                            Score
                        </th>
                        <th>
                            Bonus
                        </th>
                    </tr>
                    <tr>
                        <td>
                            <label>Intelligence</label>
                            <div class="sheet-znz-description-text">
                                Knowledge, Understanding, Exp Gain
                            </div>
                        </td>
                        <td><input type="number" name="attr_intelligence" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_intelligence_bonus" value="0"/></td>
                    </tr>
                    <tr>
                        <td>
                            <label>Strength</label>
                            <div class="sheet-znz-description-text">
                                Physical Strength, Melee Damage, Grappling
                            </div>
                        </td>
                        <td><input type="number" name="attr_strength" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_strength_bonus" value="0"/></td>
                    </tr>
                    <tr>
                        <td>
                            <label>Dexterity</label>
                            <div class="sheet-znz-description-text">
                                Speed, Agility, Dodging
                            </div>
                        </td>
                        <td><input type="number" name="attr_dexterity" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_dexterity_bonus" value="0"/></td>
                    </tr>
                    <tr>
                        <td>
                            <label>Empathy</label>
                            <div class="sheet-znz-description-text">
                                Interpersonal Skills, Charisma, Insight
                            </div>
                        </td>
                        <td><input type="number" name="attr_empathy" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_empathy_bonus" value="0"/></td>
                    </tr>
                    <tr>
                        <td>
                            <label>Awareness</label>
                            <div class="sheet-znz-description-text">
                                Perception, Scouting, Stealth
                            </div>
                        </td>
                        <td><input type="number" name="attr_awareness" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_awareness_bonus" value="0"/></td>
                    </tr>
                    <tr>
                        <td>
                            <label>Tenacity</label>
                            <div class="sheet-znz-description-text">
                                Determines Max Sanity. Mental Fortitude. Pain resistance
                            </div>
                        </td>
                        <td><input type="number" name="attr_tenacity" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_tenacity_bonus" value="0"/></td>
                    </tr>
                    <tr>
                        <td>
                            <label>Health</label>
                            <div class="sheet-znz-description-text">
                                Determines Max HP and Max Energy. Sickness resistance
                            </div></td>
                        <td><input type="number" name="attr_health" min="1" value="3" max="6"/></td>
                        <td><input type="text" class="sheet-znz-attr-bonus" readonly name="attr_health_bonus" value="0"/></td>
                    </tr>
                </table>
            </div>


            <div class="sheet-znz-subarea sheet-znz-equipment">
                <!--- Equipped Weapons-->
                <div class="sheet-znz-section-equipped-weapons">
                    <div class="sheet-znz-block-equipped">
                        <div class="sheet-znz-block-item sheet-znz-block-equipped-ranged">
                            <label>Equipped Ranged Weapon</label>
                            <div class="sheet-znz-item sheet-znz-weapon-card">
                                <div class="sheet-znz-item-field sheet-znz-field-item-name">
                                    <label>Name</label>
                                    <input type="text" name="attr_equipped_ranged_name"/>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Weight:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="number" min="0" name="attr_equipped_ranged_weight"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Ammo:
                                    </div>
    
                                    <div class="sheet-znz-item-field-row">
                                        <div class="sheet-znz-item-field">
                                            <input type="number" min="0" name="attr_equipped_ranged_ammo"/>  
                                        </div>
                                        
                                        <span class="sheet-divider">/</span>  
                                        
                                        <div class="sheet-znz-item-field">
                                            <input type="number" min="0" name="attr_equipped_ranged_ammo_max"/>
                                            <div class="sheet-znz-description-text">
                                                MAX
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Reloads:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="number" min="0" name="attr_equipped_ranged_reloads"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-note">
                                    <div class="sheet-znz-item-field-label">Notes</div> 
                                    <textarea class="sheet-znz-note" name="attr_equipped_ranged_note" ></textarea>
                                </div>
                                <div class="sheet-znz-item-field sheet-znz-weapon-equip-button">
                                    <button type="action" name="act_unequip_ranged_weapon">Unequip</button>
                                </div>
                            </div>
                        </div>
    
                        <div class="sheet-znz-block-item sheet-znz-block-equipped-melee">
                            <label>Equipped Melee Weapon</label>
                            <div class="sheet-znz-item sheet-znz-weapon-card">
                                <div class="sheet-znz-item-field sheet-znz-field-item-name">
                                    <label>Name</label>
                                    <input type="text" name="attr_equipped_melee_name"/>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Weight:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="number" min="0" name="attr_equipped_melee_weight"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Durability:
                                    </div>
    
                                    <div class="sheet-znz-item-field-row">
                                        <div class="sheet-znz-item-field">
                                            <input type="number" min="0" name="attr_equipped_melee_durability"/>  
                                        </div>
                                        
                                        <span class="sheet-divider">/</span>  
                                        
                                        <div class="sheet-znz-item-field">
                                            <input type="number" min="0" name="attr_equipped_melee_durability_max"/>
                                            <div class="sheet-znz-description-text">
                                                MAX
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row sheet-znz-melee-type-row">
                                    <div class="sheet-znz-item-field-label">
                                        Melee Type:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <select name="attr_equipped_melee_type">
                                            <option value="blunt" default>Blunt</option>
                                            <option value="sharp">Sharp</option>
                                            <option value="heavy">Heavy</option>
                                        </select>
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="text" name="attr_equipped_melee_type_note"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-note">
                                    <div class="sheet-znz-item-field-label">Notes</div> 
                                    <textarea class="sheet-znz-note" name="attr_equipped_melee_note" ></textarea>
                                </div>
                                <div class="sheet-znz-item-field sheet-znz-weapon-equip-button">
                                    <button type="action" name="act_unequip_melee_weapon">Unequip</button>
                                </div>
                            </div>
    
                        </div>
                    </div>
                </div>


                <!--- Other Equipment -->
                <div class="sheet-znz-section-other-equipment">
                    <label>Other Equipment</label>
                    <div class="sheet-znz-field-other-equipment">
                        <textarea name="attr_other_equipment" ></textarea>
                    </div>
                </div>


            </div>

        </div>
    

        <!--- Skills and Abilities-->
        <div class="sheet-znz-area">
            <div class="sheet-znz-section-skills">
                <label>Skills</label>
                <fieldset class="repeating_skills">
                    <div class="sheet-znz-block-custom-select">
                        <div class="sheet-znz-custom-label">Custom?</div>
                        <input type="checkbox" name="attr_use_custom_skill" class="sheet-znz-custom-toggle-field" />
                        <!-- hidden with css -->
                        <div class="sheet-znz-custom-select">
                            <label>Select Skill</label>
                            <select name="attr_skill_type">
                                <option value="" selected>Select Skill</option>
                                <option value="lockpicking">Lockpicking</option>
                                <option value="hotwiring">Hotwiring</option>
                                <option value="lockpicking">Hacking</option>
                                <option value="sleightofhand">Sleight of Hand</option>
                                <option value="engineering">Engineering</option>
                                <option value="electrical">Electrical Work</option>
                                <option value="electronics">Electronics</option>
                                <option value="medicine">Medicine</option>
                                <option value="pharmaceutical">Pharmaceutical</option>
                                <option value="explosives">Explosives</option>
                                <option value="biology">Biology</option>
                                <option value="boat">Boat Piloting</option>
                                <option value="plane">Plane Piloting</option>
                                <option value="cartography">Cartography</option>
                                <option value="knots">Advanced Knots</option>
                                <option value="nature">Nature</option>
                                <option value="hunting">Hunting</option>
                                <option value="farming">Farming</option>
                                <option value="construction">Construction</option>
                                <option value="tailor">Tailoring</option>
                                <option value="firearms">Gun Handling, Crafting, & Repair</option>
                                <option value="leather">Leatherworking</option>
                                <option value="metals">Metalworking</option>
                                <option value="acrobatics">Acrobatics</option>
                                <option value="animal">Animal Handling</option>
                            </select>
                        </div>
                        <div class="sheet-znz-custom-input">
                            <label>Custom Skill Name</label>
                            <div class="sheet-znz-custom-input-wrapper"><input class="sheet-znz-custom-input-field" type="text" name="attr_skill_custom_name"/></div>
                        </div>
                        <div class="sheet-znz-custom-bonus">
                            <label>Bonus</label>
                            <div class="sheet-znz-custom-bonus-input"><input type="number" name="attr_skill_bonus"/></div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="sheet-znz-section-abilities">
                <label>Abilities</label>
                <fieldset class="repeating_abilities">
                    <div class="sheet-znz-block-trait">
                        <div class="sheet-znz-trait-select">
                            <select name="attr_ability">
                                <option value="default" default>Select Ability</option>
                                <option value="bullseye">Bulls Eye</option>
                                <option value="lucky">Lucky</option>
                                <option value="stable">Stable</option>
                                <option value="martialartist">Martial Artist</option>
                                <option value="motivational">Motivational</option>
                                <option value="highoctane">High Octane</option>
                                <option value="knowledgeable">Knowledgeable</option>
                                <option value="speedster">Speedster</option>
                            </select>
                        </div>
                        <div class="sheet-znz-trait-descript">
                            <textarea type="text" readonly name="attr_abilitytext"></textarea>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>

         <!--- Proficiencies and Flaws-->
        <div class="sheet-znz-area">
            <div class="sheet-znz-section-proficiency">
                <label>Proficiencies</label>
                <fieldset class="repeating_proficiency">
                    <div class="sheet-znz-block-custom-select">
                        <div class="sheet-znz-custom-label">Custom?</div>
                        <input type="checkbox" name="attr_use_custom_proficiency" class="sheet-znz-custom-toggle-field" />
                        <!-- hidden with css -->
                        <div class="sheet-znz-custom-select">
                            <label>Select Proficiency</label>
                            <select name="attr_skill_type">
                                <option value="" selected>Select Proficiency</option>
                                <option value="pistols">Shooting Pistols</option>
                                <option value="shotguns">Shooting Shotguns</option>
                                <option value="rifles">Shooting Rifles</option>
                                <option value="unarmed">Unarmed Combat</option>
                                <option value="sharpmelee">Sharp Melee Weapons</option>
                                <option value="bluntmelee">Blunt Melee Weapons</option>
                                <option value="throwing">Throwing Weapons</option>
                                <option value="archery">Archery</option>
                                <option value="stealth">Stealth</option>
                                <option value="pickpocket">Pickpocketing</option>
                                <option value="repair">Basic Repair</option>
                                <option value="crafting">Basic Crafting</option>
                                <option value="driving">Driving</option>
                                <option value="cooking">Cooking</option>
                                <option value="firstaid">First Aid</option>
                                <option value="survival">Survival</option>
                                <option value="performance">Performance</option>
                                <option value="intimidation">Intimidation</option>
                                <option value="persuasion">Persuasion</option>
                                <option value="negotiation">Negotiation</option>
                                <option value="investigation">Investigation</option>
                                <option value="climbing">Climbing</option>
                                <option value="swimming">Swimming</option>
                                <option value="swimming">Athletics</option>
                            </select>
                        </div>
                        <div class="sheet-znz-custom-input">
                            <label>Custom Proficiency</label>
                            <div class="sheet-znz-custom-input-wrapper"><input class="sheet-znz-custom-input-field" type="text" name="attr_skill_custom_name"/></div>
                        </div>
                        <div class="sheet-znz-custom-bonus">
                            <label>Bonus</label>
                            <div class="sheet-znz-custom-bonus-input"><input type="number" name="attr_skill_bonus"/></div>
                        </div>
                    </div>
                </fieldset>
            </div>
            
            <div class="sheet-znz-section-flaws">
                <div class="sheet-znz-spaced-between">
                    <label>Flaws</label>
                    <button type="action" name="act_randomizeflaw">Randomize</button>
                </div>
                <fieldset class="repeating_flaws">
                    <div class="sheet-znz-block-trait">
                        <div class="sheet-znz-field-trait-select">
                            <select name="attr_flaw" readonly>
                                <option value="default" default>Select Flaw</option>
                                <option value="nearsighted">Nearsighted</option>
                                <option value="curious">Curious</option>
                                <option value="sickly">Sickly</option>
                                <option value="clumsy">Clumsy</option>
                                <option value="alcoholic">Alcoholic</option>
                                <option value="unlucky">Unlucky</option>
                                <option value="fainthearted">Fainthearted</option>
                                <option value="vulnerable">Vulnerable</option>
                            </select>
                        </div>
                        <div class="sheet-znz-field-trait-descript">
                            <textarea type="text" readonly name="attr_flawtext"></textarea>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>


        <div class="sheet-znz-area-unflexed">
            <label>Inventory</label>
            <div class="sheet-znz-section-inventory">
                <div class="sheet-znz-inventory-info sheet-znz-spaced-between">
                    <div class="sheet-znz-inventory-field-bag-select">
                        <div>
                            Bag Type:
                        </div>
                        <select name="attr_bagtype">
                            <option value="none" default>No Bag</option>
                            <option value="tiny">Satchel</option>
                            <option value="small">Daypack</option>
                            <option value="medium">Medium Backpack</option>
                            <option value="large">Large Rucksack</option>
                        </select>
                    </div>
                    <div class="sheet-znz-inventory-current-weight">
                        <div class="sheet-znz-inventory-label-current-weight">
                            Current Weight: 
                        </div>
                        <div class="sheet-znz-inventory-field-current-weight">
                            <input type="hidden" class="sheet-znz-hidden-weight-check" name="attr_weight_check" value="0"/>
                            <input type="number" class="sheet-znz-weight-check" name="attr_inventory_weight" readonly/>
                        </div>
                    </div>
                    <div class="sheet-znz-inventory-max-weight">
                        <div class="sheet-znz-inventory-field-bag-weight-label">
                            Max Weight:
                        </div>
                        <div class="sheet-znz-inventory-field-bag-weight-max">
                            <input type="number" name="attr_inventory_max_weight" readonly/>
                        </div>
                    </div>
                </div>
                <div class="sheet-znz-block-wrapper">
                    <div class="sheet-znz-block-item">
                        <input type="hidden" name="attr_ranged_total_weight" value="0"/>
                        <label class="sheet-znz-header">Ranged Weapons</label>
                        <fieldset class="repeating_ranged">
                            <div class="sheet-znz-item sheet-znz-weapon-card">
                                <div class="sheet-znz-item-field sheet-znz-field-item-name">
                                    <label>Name</label>
                                    <input type="text" name="attr_inv_ranged_name"/>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Weight:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="number" min="0" name="attr_inv_ranged_weight"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Ammo:
                                    </div>
    
                                    <div class="sheet-znz-item-field-row">
                                        <div class="sheet-znz-item-field">
                                            <input type="number" min="0" name="attr_inv_ranged_ammo"/>  
                                        </div>
                                        
                                        <span class="sheet-divider">/</span>  
                                        
                                        <div class="sheet-znz-item-field">
                                            <input type="number" name="attr_inv_ranged_ammo_max"/>
                                            <div class="sheet-znz-description-text">
                                                MAX
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Reloads:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="number" min="0" name="attr_inv_ranged_reloads"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-note">
                                    <div class="sheet-znz-item-field-label">Notes</div> 
                                    <textarea class="sheet-znz-note" name="attr_inv_ranged_note" ></textarea>
                                </div>
                                <div class="sheet-znz-item-field sheet-znz-weapon-equip-button">
                                    <button type="action" name="act_equiprange">Equip</button>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="sheet-znz-block-item">
                        <input type="hidden" name="attr_melee_total_weight" value="0"/>
                        <label class="sheet-znz-header">Melee Weapons</label>
                        <fieldset class="repeating_melee">
                            <div class="sheet-znz-item sheet-znz-weapon-card">
                                <div class="sheet-znz-item-field sheet-znz-field-item-name">
                                    <label>Name</label>
                                    <input type="text" name="attr_inv_melee_name"/>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Weight:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="number" min="0" name="attr_inv_melee_weight"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field-label">
                                        Durability:
                                    </div>
    
                                    <div class="sheet-znz-item-field-row">
                                        <div class="sheet-znz-item-field">
                                            <input type="number" min="0" name="attr_inv_melee_durability"/>  
                                        </div>
                                        
                                        <span class="sheet-divider">/</span>  
                                        
                                        <div class="sheet-znz-item-field">
                                            <input type="number" name="attr_inv_melee_durability_max"/>
                                            <div class="sheet-znz-description-text">
                                                MAX
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-row sheet-znz-melee-type-row">
                                    <div class="sheet-znz-item-field-label">
                                        Melee Type:
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <select name="attr_inv_melee_type">
                                            <option value="blunt" default>Blunt</option>
                                            <option value="sharp">Sharp</option>
                                            <option value="heavy">Heavy</option>
                                        </select>
                                    </div>
                                    <div class="sheet-znz-item-field">
                                        <input type="text" name="attr_inv_melee_type_note"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-note">
                                    <div class="sheet-znz-item-field-label">Notes</div> 
                                    <textarea class="sheet-znz-note" name="attr_inv_melee_note" ></textarea>
                                </div>
                                <div class="sheet-znz-item-field sheet-znz-weapon-equip-button">
                                    <button type="action" name="act_equipmelee">Equip</button>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="sheet-znz-block-item">
                        <input type="hidden" name="attr_misc_total_weight" value="0"/>
                        <label class="sheet-znz-header">Items</label>
                        <fieldset class="repeating_inventory">
                            <div class="sheet-znz-item">
                                <div class="sheet-znz-item-field sheet-znz-field-item-name-misc">
                                    <label>Name</label>
                                    <input type="text" name="attr_inv_item_name"/>
                                </div>
                                <div class="sheet-znz-item-row">
                                    <div class="sheet-znz-item-field sheet-znz-field-item-count"weight>
                                        <div class="sheet-znz-item-field-label">Quantity</div> 
                                        <input type="number" min="0" name="attr_inv_item_quantity"/>
                                    </div>
                                    <div class="sheet-znz-item-field sheet-znz-field-item-weight">
                                        <div class="sheet-znz-item-field-label">Weight</div> 
                                        <input type="number" min="0" name="attr_inv_item_weight"/>
                                    </div>
                                </div>
                                <div class="sheet-znz-item-field sheet-znz-field-item-note">
                                    <div class="sheet-znz-item-field-label">Notes</div> 
                                    <textarea class="sheet-znz-note" name="attr_inv_item_note" ></textarea>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>

    
            
    
        <div class="sheet-znz-block sheet-znz-block-notes">
            <label>Notes</label>
            <textarea type="text" name="attr_notes"></textarea>
        </div>
    </div>

    <script type="text/javascript">
        const stats = [
    "intelligence",
    "strength", 
    "dexterity",
    "empathy",
    "awareness",
    "tenacity",
    "health"
    ];


const setTotalAttrs = () => {
    getAttrs(stats, values => {
        let val = Object.values(values);

        let total = 0

        for (field in val){

            let count = parseInt(val[field], 10);
            total += count;
        }

        console.log("Total Attributes: " + total);

        setAttrs({
            ['total_attr_points']: total
        })


    });
}



stats.forEach(function (stat) {
    on("change:" + stat, function() {
        getAttrs([stat], function (values) {
            const score = parseInt(values[stat], 10) || 0;
            const mod = score - 3;

            mod > 0 ? setAttrs({ [stat + '_bonus']: "+" + mod }) : setAttrs({ [stat + '_bonus']: mod });
            
            setTotalAttrs();

            if (stat == "health"){
                const energy = score * 10;
                const health = score * 5;
                setAttrs({
                    ['hp_max'] : health,
                    ['energy_max'] : energy

                });
            }

            if (stat == 'tenacity'){
                const sanity = score * 5;

                setAttrs({
                    ['sanity_max']:sanity   
                });
            }

        });
    });
});


        var availableAbilities = {
        default:
            "Select an ability to see its description.",
        bullseye: 
            "+ Know exactly how much a ranged attack challenge is. \n\n + Ranged weapons critically strike on a natural 9.",
        martialartist: 
            "+ Know exactly how much a melee attack challenge level is. \n\n + Successful dodging allows you to make a free melee attack roll.",
        lucky: 
            "+ 3 times a play session, you can re-roll any roll. You can choose which roll to accept. ",
        stable: 
            "+ When your sanity breaks, choose which traumatic response action to take. \n\n + You can give your sanity points to other players.",
        motivational: 
            "+ 3 times a day, give someone else a +2 bonus prior to their next roll as a free action.",
        highoctane: 
            "+ You can take one additional combat action on your turn in exchange for 3 energy.",
        knowledgeable: 
            "+ Once a day, you can attempt any skill action for a skill you don't possess by passing an intelligence check first. You must still roll the skill check after.",
        speedster:
            "+ Gain an additional 2 movement speed. \n + Gain ability to jump back one space as an action or when you attempt to dodge."
}



var availableFlaws = {
        default:
            "Select a flaw to see its description.",
        nearsighted: 
            "- Occasionally, your glasses may break. \n\n - Once your glasses are broken, you can attempt to fix them or scavenge for other glasses with matching prescriptions. \n\n - Once your glasses are broken, reduce all awareness and ranged attack rolls by half.",
        curious: 
            "- Occasionally, you will have an urge to explore or visit an certain area. \n\n - You can resist this urge by spending 10 sanity.",
        sickly: 
            "- You have a condition which requires taking 1 special medicine each day. \n\n - On days you do not take this medicine, take a third of your maximum health as damage. \n\n - Start the game with 7 of the special medicine.",
        clumsy: 
            "- When doing actions such as sneaking or scavenging, you will occasionally cause a disturbance which leads to an encounter. \n\n - Occasionally, you can slip or trip while moving.",
        alcoholic: 
            "- You have constant urges to drink alcohol once a day.   \n\n - If you fail to do so by the end of the day. you will take 2 health, sanity, and energy damage. \n\n - This damage doubles for each consecutive day you fail to do so and resets to 2 after you consume some. \n\n You cannot hit 0 through this effect. This effect will can only reduce you to 1 at most.",
        fainthearted:
            "- Occasionally, roll a tenacity check at the start of a battle. If you fail the check, your first action will be a freeze.",
        vulnerable:
            "- Roll a health check whenever you take damage. If you fail the check, take double damage.",
        unlucky: 
            "- 3 times a play session, the ZM will force you to re-roll your dice roll, making you take the lower roll.",
}




on("change:repeating_abilities:ability", function(eventInfo){
    getAttrs([
        "repeating_abilities_ability"
    ], function(value){
        var abilityName = value["repeating_abilities_ability"];


        if (abilityName in availableAbilities){
            setAttrs({
                repeating_abilities_abilitytext: availableAbilities[abilityName]
            });
        }
    });
});

on("change:repeating_flaws:flaw", function(eventInfo){
    getAttrs([
        "repeating_abilities_flaw"
    ], function(value){
        var flawName = value["repeating_abilities_flaw"];


        if (flawName in availableFlaws){
            setAttrs({
                repeating_abilities_flawtext: availableFlaws[flawName]
            });
        }
    });
});










        //Button Actions
on("clicked:unequip_ranged_weapon", function(eventInfo){
    unequip_weapon("ranged");
});

on("clicked:unequip_melee_weapon", function(eventInfo){
    unequip_weapon("melee");
});

// Repeater Button Actions - can't have multiple underscores.
on("clicked:repeating_melee:equipmelee", function(eventInfo){
    //strip out everything after last underscore, which would be the button's name
    //gets us the row ID
    var underscoreIndex = eventInfo.sourceAttribute.lastIndexOf("_"),
        rowId = eventInfo.sourceAttribute.substr(0, underscoreIndex);

    unequip_weapon("melee");
    equip_weapon("melee", rowId)
});

on("clicked:repeating_ranged:equiprange", function(eventInfo){
    //strip out everything after last underscore, which would be the button's name
    //gets us the row ID
    var underscoreIndex = eventInfo.sourceAttribute.lastIndexOf("_"),
        rowId = eventInfo.sourceAttribute.substr(0, underscoreIndex);

    unequip_weapon("ranged");
    equip_weapon("ranged", rowId)
});


// Unequip - basically a move function. 
function unequip_weapon(type){

    var weaponFields = getWeaponFields(type, "equipped_" + type + "_"); //examples: equipped_ranged_ammo  ,  equipped_melee_durability
    
    getAttrs(weaponFields, function (values){

        //check if we actually have values in the equipped weapon. before unequipping
        var isEmpty = true;
        for (let val in values){
            if (values[val].length){
                isEmpty = false;
            }
        }
        if (isEmpty){
            return;
        }

        //Create new Row
        var newInvRowId = generateRowID();
        var newInvRowAttrs = {};

        //get the keys for inventory item and equipped item.
        var invFields = getWeaponFields(type, "repeating_" + type + "_" + newInvRowId + "_inv_" + type + "_"),
            valueFields = getWeaponFields(type, "equipped_" + type +  "_");

        // loop is shorthand for: newInvRowAttrs["repeating_" + type + "_" + newInvRowId + "_inv_" + type + "_name"] = values["equipped_" + type + "_name"];
        for (let i = 0; i < invFields.length; i++){
            newInvRowAttrs[invFields[i]] = values[valueFields[i]];
        }

        //add new row in inventory. 
        setAttrs(newInvRowAttrs);


        //struct for clearing equipped weapon.
        var fieldClearStruct = getWeaponFields(type, "equipped_" + type + "_", true) //example ['equipped_ranged_note'] : ''

        setAttrs(fieldClearStruct);
    });
}


//Equip inventory item.
function equip_weapon(type, rowId){

    var weaponFields = getWeaponFields(type, rowId + "_inv_" + type + "_"); //examples: equipped_ranged_ammo  ,  equipped_melee_durability

    getAttrs(weaponFields, function (values){

        if (Object.keys(values).length === 0) {
            return;
        }



        var fieldSetStruct = getWeaponFields(type, "equipped_" + type + "_", true), //the struct to be set
            fieldValues = getWeaponFields(type, ""); // simple array of values that we will need as keys for both fieldSetStruct and values


        for (let i = 0; i < fieldValues.length; i++){
            fieldSetStruct["equipped_" + type + "_" + fieldValues[i]] = values[rowId + "_inv_" + type + "_" + fieldValues[i]];
        }

        //set equipped and remove current.
        setAttrs(fieldSetStruct);
        removeRepeatingRow(rowId);

    });
}




/**
 * Helper in order to get arrays or structs of weapon field names needed for the various functions.
 * Lets us use a single equip weapon function as it handles both fields for ranged or melee
 * These are often used to dynamically loop over keys in a struct.
 * 
 * @param {string} type Melee or Ranged
 * @param {string} prefix String appended in front of each returned field name
 * @param {boolean} asStruct Determine if we return a struct or an array.
 */
function getWeaponFields(type, prefix, asStruct = false){
    var rangedFields = ["name", "weight", "ammo", "ammo_max", "reloads", "note"],
        meleeFields = ["name", "weight", "durability", "durability_max", "durability_rating", "note"],
        targetField = [];


    //which field array to use. 
    if (type === "ranged"){
        targetField = rangedFields;
    } else if (type === "melee"){
        targetField = meleeFields;
    }
 
    if (asStruct){
        //Return struct, in which each key is the a field name with a prefix and set the value to ""
        let resultStruct = {};

        for (let i = 0; i < targetField.length; i++) {
            resultStruct[prefix + targetField[i]] = "";
        }

        return resultStruct;
    } else{
        //Return array of field names with a prefix.
        for(let i = 0; i < targetField.length; i++){
            targetField[i]= prefix + targetField[i];
        }

        return targetField;
    }
}
        var bagTypes = {
    none: 5,
    tiny: 10,
    small: 25,
    medium: 40,
    large: 75
}


on("change:bagtype", function(eventInfo){
    getAttrs([
        "bagtype"
    ], function(value){
        let bag = value['bagtype'];

        if (bag in bagTypes){
            setAttrs({
                inventory_max_weight: bagTypes[bag]
            });
        }
    });
});
        //Update hidden ranged weight
on ('change:repeating_ranged:inv_ranged_weight remove:repeating_ranged', function(){
    repeatingSum('ranged_total_weight', 'ranged', 'inv_ranged_weight');
});

//Update hidden melee weight
on ('change:repeating_melee:inv_melee_weight remove:repeating_melee', function(){
    repeatingSum('melee_total_weight', 'melee', 'inv_melee_weight');
});

//Update hidden item weight
on ('change:repeating_inventory:inv_item_weight change:repeating_inventory:inv_item_quantity  remove:repeating_inventory', function(){
    repeatingSum('misc_total_weight', 'inventory', ['inv_item_weight', 'inv_item_quantity']);
});

//Add up weights
on ('change:misc_total_weight change:melee_total_weight change:ranged_total_weight', function(){
    getAttrs([
        'melee_total_weight',
        'misc_total_weight',
        'ranged_total_weight',
        'inventory_weight',
        'inventory_max_weight'
    ], function(values){
        let melee = values['melee_total_weight'],
            ranged = values['ranged_total_weight'],
            misc = values['misc_total_weight'],
            currentWeight = values['inventory_weight'],
            maxWeight = values['inventory_max_weight'],
            exceedWeight = false;

        let newWeight = melee + ranged + misc;

        if (newWeight === currentWeight){
            return;
        }

        if (newWeight > maxWeight){
            exceedWeight = true;
        }

        setAttrs({
            ['inventory_weight']: newWeight,
            ['weight_check']: (exceedWeight) ? 1 : 0
        })

    });
});


//https://wiki.roll20.net/RepeatingSum
const repeatingSum = (destinations, section, fields) => {
    if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
    if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
            const output = {};
            destinations.forEach((destination, index) => {
                output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
            });
            setAttrs(output);
        }); 
    }); 
};
        //This has to be included AFTER workers-abilities-flaws.js
//Randomizes a flaw

on("clicked:randomizeflaw", function(){
    let keys = Object.keys(availableFlaws);

    let randomKey = keys[keys.length * Math.random() << 0];

    //Prevent it for being the Default option. 
    while (randomKey === "default"){
        randomKey = keys[keys.length * Math.random() << 0];
    }

    var newFlawId = generateRowID();
    var newFlaw = {};

    newFlaw["repeating_flaws_" + newFlawId + "_flaw"] = randomKey;

    setAttrs(newFlaw);

});
    </script>

    </body>


</html>
    